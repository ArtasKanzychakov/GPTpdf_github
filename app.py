#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä: –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∏—à
–í–µ—Ä—Å–∏—è 6.0 - –ì–ª—É–±–æ–∫–∏–π –æ–ø—Ä–æ—Å, –ø–æ—Ö–≤–∞–ª–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–¥–µ–π, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
"""

import os
import logging
import asyncio
import json
import re
import sys
import random
import requests
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple, Any
from dataclasses import dataclass, field
from enum import Enum
from collections import defaultdict

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

import aiohttp
from aiohttp import web

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================
class BotState(Enum):
    DEMOGRAPHY = 1
    PERSONALITY = 2
    SKILLS = 3
    VALUES = 4
    LIMITATIONS = 5
    ANALYZING = 6
    NICHE_SELECTION = 7
    DETAILED_PLAN = 8

class NicheType(Enum):
    QUICK_START = "üî• –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç"
    BALANCED = "üöÄ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"
    LONG_TERM = "üå± –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π"
    RISKY = "üíé –†–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π"
    HIDDEN = "üéØ –°–∫—Ä—ã—Ç–∞—è –Ω–∏—à–∞"

# ==================== –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ====================
@dataclass
class UserProfile:
    user_id: int
    chat_id: int
    created_at: datetime = field(default_factory=datetime.now)
    last_activity: datetime = field(default_factory=datetime.now)
    
    # –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è
    age_group: Optional[str] = None
    education: Optional[str] = None
    location: Optional[str] = None
    custom_location: Optional[str] = None
    
    # –õ–∏—á–Ω–æ—Å—Ç—å –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è
    motivation: List[str] = field(default_factory=list)
    decision_style: Optional[str] = None
    risk_tolerance: int = 5
    risk_scenario: Optional[str] = None
    energy_morning: int = 3
    energy_day: int = 3
    energy_evening: int = 3
    energy_analytical: Optional[str] = None
    energy_creative: Optional[str] = None
    energy_social: Optional[str] = None
    fears_selected: List[str] = field(default_factory=list)
    fears_custom: Optional[str] = None
    
    # –ù–∞–≤—ã–∫–∏
    skills_analytics: int = 3
    skills_communication: int = 3
    skills_design: int = 3
    skills_organization: int = 3
    skills_manual: int = 3
    skills_eq: int = 3
    superpower: Optional[str] = None
    work_style: Optional[str] = None
    learning_practice: int = 0
    learning_books: int = 0
    learning_courses: int = 0
    learning_group: int = 0
    learning_observation: int = 0
    
    # –¶–µ–Ω–Ω–æ—Å—Ç–∏
    existential_answer: Optional[str] = None
    flow_experience: Optional[str] = None
    flow_feeling: Optional[str] = None
    ideal_client_age: Optional[str] = None
    ideal_client_field: Optional[str] = None
    ideal_client_pain: Optional[str] = None
    ideal_client_details: Optional[str] = None
    
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
    budget: Optional[str] = None
    equipment: List[str] = field(default_factory=list)
    equipment_custom: Optional[str] = None
    knowledge_assets: List[str] = field(default_factory=list)
    time_per_week: Optional[str] = None
    business_scale: Optional[str] = None
    business_format: Optional[str] = None
    
    # AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    psychological_analysis: Optional[str] = None
    generated_niches: List[Dict] = field(default_factory=list)
    detailed_plans: Dict[str, str] = field(default_factory=dict)
    current_niche_index: int = 0
    selected_niche: Optional[Dict] = None
    
    # UX
    current_question: int = 0
    questions_answered: int = 0
    total_questions: int = 18
    learning_points_assigned: int = 0

@dataclass
class TokenUsage:
    total_tokens: int = 0
    prompt_tokens: int = 0
    completion_tokens: int = 0
    estimated_cost: float = 0.0
    
    def add_usage(self, prompt_tokens: int, completion_tokens: int):
        self.prompt_tokens += prompt_tokens
        self.completion_tokens += completion_tokens
        self.total_tokens = self.prompt_tokens + self.completion_tokens
        self.estimated_cost = self.total_tokens * 0.002 / 1000
    
    def get_percentage_used(self, limit: int = 100000) -> float:
        return min((self.total_tokens / limit) * 100, 100.0) if limit > 0 else 0.0
    
    def get_usage_bar(self, limit: int = 100000) -> str:
        percent = self.get_percentage_used(limit)
        filled = int(percent / 10)
        bar = "üü¢" * filled + "‚ö™" * (10 - filled)
        
        if percent >= 80:
            bar = "üî¥" * filled + "‚ö™" * (10 - filled)
        elif percent >= 50:
            bar = "üü°" * filled + "‚ö™" * (10 - filled)
        
        return f"{bar} {percent:.1f}%"

@dataclass
class ChatMemory:
    total_messages: int = 0
    user_profiles: Dict[int, UserProfile] = field(default_factory=dict)
    token_usage: TokenUsage = field(default_factory=TokenUsage)
    
    def get_memory_usage_percentage(self) -> float:
        try:
            base_memory = 50 * 1024 * 1024
            profile_memory = len(self.user_profiles) * 10 * 1024
            message_memory = self.total_messages * 4 * 1024
            
            total_used = base_memory + profile_memory + message_memory
            total_limit = 512 * 1024 * 1024
            
            return min((total_used / total_limit) * 100, 100.0)
        except:
            return 0.0

# ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
chat_memory = ChatMemory()
PRAISE_PHRASES = [
    "–û—Ç–ª–∏—á–Ω–æ! –í–∏–∂—É, –≤—ã –ø–æ–¥—Ö–æ–¥–∏—Ç–µ –∫ –¥–µ–ª—É —Å–µ—Ä—å–µ–∑–Ω–æ üëè",
    "–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –æ—Ç–≤–µ—Ç! –≠—Ç–æ –º–Ω–æ–≥–æ–µ –ø—Ä–æ—è—Å–Ω—è–µ—Ç üí°",
    "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –í—ã —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç–µ—Å—å —Å –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç–æ–π üåü",
    "–í–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ! –¢–∞–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–µ–ª–∞—é—Ç –∞–Ω–∞–ª–∏–∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–º üéØ",
    "–ë—Ä–∞–≤–æ! –í—ã –º—ã—Å–ª–∏—Ç–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, —ç—Ç–æ —Ü–µ–Ω–Ω–æ üöÄ",
    "–ü–æ—Ç—Ä—è—Å–∞—é—â–µ! –ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –≥–ª—É–±–∏–Ω–∞ –º—ã—à–ª–µ–Ω–∏—è üß†",
    "–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! –í—ã –¥–µ–ª–∞–µ—Ç–µ —ç—Ç—É –∞–Ω–∫–µ—Ç—É –ª—É—á—à–µ —Å –∫–∞–∂–¥—ã–º –æ—Ç–≤–µ—Ç–æ–º üíé",
    "–ò–∑—É–º–∏—Ç–µ–ª—å–Ω–æ! –¢–∞–∫–æ–π –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º ‚ú®",
    "–ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ! –í–∏–∂—É —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑—É üìä",
    "–ë–ª–µ—Å—Ç—è—â–µ! –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã - –∑–æ–ª–æ—Ç–∞—è –∂–∏–ª–∞ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –Ω–∏—à–∏ üèÜ",
    "–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –í—ã —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç–µ —Ç–∞–∫–∏–µ –≥—Ä–∞–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–¥–∫–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è üí´",
    "–ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ! –ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –±–æ–ª—å—à–æ–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª üåà",
    "–§–µ–Ω–æ–º–µ–Ω–∞–ª—å–Ω–æ! –¢–∞–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–µ–ª–∞—é—Ç —Ä–∞–±–æ—Ç—É AI –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É —Ü–µ–Ω–Ω–æ–π ü§ñ",
    "–í–æ—Å—Ö–∏—â–∞—é—Å—å –≤–∞—à–µ–π —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é –∏ –≥–ª—É–±–∏–Ω–æ–π! –≠—Ç–æ –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É üîë",
    "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ! –ß–µ–º –±–æ–ª—å—à–µ —É–∑–Ω–∞—é, —Ç–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è üé¢"
]

# ==================== OPENAI –°–ï–†–í–ò–° ====================
class OpenAIService:
    def __init__(self):
        self.api_key = os.getenv("OPENAI_API_KEY")
        self.is_available = bool(self.api_key)
        logger.info(f"üîå OpenAI: {'–î–æ—Å—Ç—É–ø–µ–Ω' if self.is_available else '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}")
    
    def create_analysis_prompt(self, profile: UserProfile) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        return f"""–¢—ã - –Ω–µ–π—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –±–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ç–µ–≥ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. 
–ü—Ä–æ–≤–µ–¥–∏ –ì–õ–£–ë–û–ö–ò–ô –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –∏ —Å–æ—Å—Ç–∞–≤—å –±–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é.

## –ü–û–õ–ù–´–ô –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:

### 1. –î–ï–ú–û–ì–†–ê–§–ò–Ø:
- –í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞: {profile.age_group}
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: {profile.education}
- –õ–æ–∫–∞—Ü–∏—è: {profile.custom_location or profile.location}

### 2. –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–û–†–¢–†–ï–¢:
- –ö–ª—é—á–µ–≤–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è: {', '.join(profile.motivation)}
- –°—Ç–∏–ª—å –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π: {profile.decision_style}
- –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ —Ä–∏—Å–∫—É: {profile.risk_tolerance}/10 (—Å—Ü–µ–Ω–∞—Ä–∏–π: {profile.risk_scenario})
- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å: –£—Ç—Ä–æ={profile.energy_morning}/7, –î–µ–Ω—å={profile.energy_day}/7, –í–µ—á–µ—Ä={profile.energy_evening}/7
- –ü–∏–∫–æ–≤–∞—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞={profile.energy_analytical}, –ö—Ä–µ–∞—Ç–∏–≤={profile.energy_creative}, –û–±—â–µ–Ω–∏–µ={profile.energy_social}
- –ì–ª—É–±–∏–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏: {', '.join(profile.fears_selected)} + "{profile.fears_custom}"

### 3. –ù–ê–í–´–ö–ò (–æ—Ü–µ–Ω–∫–∞ 1-5):
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞/–ª–æ–≥–∏–∫–∞: {profile.skills_analytics}/5
- –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è/–ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã: {profile.skills_communication}/5
- –î–∏–∑–∞–π–Ω/–∫—Ä–µ–∞—Ç–∏–≤: {profile.skills_design}/5
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: {profile.skills_organization}/5
- –†—É—á–Ω–æ–π —Ç—Ä—É–¥/–º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ: {profile.skills_manual}/5
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç: {profile.skills_eq}/5
- –°—É–ø–µ—Ä—Å–∏–ª–∞: {profile.superpower}
- –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã: {profile.work_style}
- –°—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è: –ü—Ä–∞–∫—Ç–∏–∫–∞={profile.learning_practice}, –ö–Ω–∏–≥–∏={profile.learning_books}, –ö—É—Ä—Å—ã={profile.learning_courses}, –ì—Ä—É–ø–ø–∞={profile.learning_group}, –ù–∞–±–ª—é–¥–µ–Ω–∏–µ={profile.learning_observation}

### 4. –¶–ï–ù–ù–û–°–¢–ò –ò –ò–ù–¢–ï–†–ï–°–´:
- –≠–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: "{profile.existential_answer}"
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ç–æ–∫–∞: "{profile.flow_experience}" (–æ—â—É—â–µ–Ω–∏—è: "{profile.flow_feeling}")
- –ò–¥–µ–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç: {profile.ideal_client_age}, —Å—Ñ–µ—Ä–∞: {profile.ideal_client_field}, –±–æ–ª—å: {profile.ideal_client_pain}, –¥–µ—Ç–∞–ª–∏: "{profile.ideal_client_details}"

### 5. –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
- –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±—é–¥–∂–µ—Ç: {profile.budget}
- –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: {', '.join(profile.equipment)}
- –ó–Ω–∞–Ω–∏—è/–∞–∫—Ç–∏–≤—ã: {', '.join(profile.knowledge_assets)}
- –í—Ä–µ–º—è –≤ –Ω–µ–¥–µ–ª—é: {profile.time_per_week}
- –ú–∞—Å—à—Ç–∞–± –±–∏–∑–Ω–µ—Å–∞: {profile.business_scale}
- –§–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã: {profile.business_format}

## –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï:

### 1. –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–û–†–¢–†–ï–¢ (–¥–µ—Ç–∞–ª—å–Ω–æ):
- –û—Å–Ω–æ–≤–Ω—ã–µ —á–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∏ –º—ã—à–ª–µ–Ω–∏—è
- –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–∫–∞–∫ –∏—Ö –º–æ–Ω–µ—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å)
- –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–∫–∞–∫ –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å)
- –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

### 2. –°–ö–†–´–¢–´–ô –ü–û–¢–ï–ù–¶–ò–ê–õ:
- –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–∞–≤—ã–∫–æ–≤
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –∏–∑ —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- –ß—Ç–æ —á–µ–ª–æ–≤–µ–∫ —É–º–µ–µ—Ç, –Ω–æ –Ω–µ —Ü–µ–Ω–∏—Ç
- –ù–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è

### 3. –ò–î–ï–ê–õ–¨–ù–´–ï –£–°–õ–û–í–ò–Ø –î–õ–Ø –ë–ò–ó–ù–ï–°–ê:
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã (–æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω/–≥–∏–±—Ä–∏–¥)
- –¢–µ–º–ø —Ä–æ—Å—Ç–∞ (–±—ã—Å—Ç—Ä—ã–π/—É–º–µ—Ä–µ–Ω–Ω—ã–π/–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π)
- –¢–∏–ø –∫–ª–∏–µ–Ω—Ç–æ–≤/–ø—Ä–æ–µ–∫—Ç–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)
- –†–∞–±–æ—á–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è)

### 4. –û–°–û–ë–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò (—Å —É—á–µ—Ç–æ–º –¥–µ–º–æ–≥—Ä–∞—Ñ–∏–∏):
- –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—ã—Ç
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ª–æ–∫–∞—Ü–∏–∏ (–≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –Ω–∏—à–∏)
- –£—á–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

–í–ï–†–ù–ò –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –û–¢–í–ï–¢ –ë–ï–ó –û–ë–©–ò–• –§–†–ê–ó. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."""

    def create_niches_prompt(self, profile: UserProfile, analysis: str) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∏—à"""
        return f"""–¢—ã - –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å —Å –æ–ø—ã—Ç–æ–º —Å–æ–∑–¥–∞–Ω–∏—è 50+ –±–∏–∑–Ω–µ—Å–æ–≤.
–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–∑–¥–∞–π 8 –ö–û–ù–ö–†–ï–¢–ù–´–• –ë–ò–ó–ù–ï–°-–ù–ò–®.

## –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{analysis}

## –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
- –í–æ–∑—Ä–∞—Å—Ç: {profile.age_group}
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: {profile.education}
- –õ–æ–∫–∞—Ü–∏—è: {profile.custom_location or profile.location}
- –ë—é–¥–∂–µ—Ç: {profile.budget}
- –í—Ä–µ–º—è: {profile.time_per_week}
- –ú–∞—Å—à—Ç–∞–±: {profile.business_scale}
- –§–æ—Ä–º–∞—Ç: {profile.business_format}

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ù–ò–®–ê–ú:

### 1-2. üî• –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ (–ø–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏ –∑–∞ 1-2 –º–µ—Å—è—Ü–∞)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è
- –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏
- –†–µ–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫ –≤ –ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 3-4. üöÄ –°–ë–ê–õ–ê–ù–°–ò–†–û–í–ê–ù–ù–´–ô (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –∑–∞ 3-6 –º–µ—Å—è—Ü–µ–≤)
- –£–º–µ—Ä–µ–Ω–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∞–∑–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–≤–º–µ—â–µ–Ω–∏—è —Å —Ä–∞–±–æ—Ç–æ–π
- –ß–µ—Ç–∫–∏–π –ø–ª–∞–Ω –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

### 5-6. üå± –î–û–õ–ì–û–°–†–û–ß–ù–´–ô (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ 1-2 –≥–æ–¥–∞)
- –°–µ—Ä—å–µ–∑–Ω—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–æ—Å—Ç–∞
- –í—ã—Å–æ–∫–∏–π –ø–æ—Ç–æ–ª–æ–∫ –¥–æ—Ö–æ–¥–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã/–±—Ä–µ–Ω–¥–∞
- –£—á–µ—Ç —Ç—Ä–µ–Ω–¥–æ–≤ —Ä—ã–Ω–∫–∞

### 7. üíé –†–ò–°–ö–û–í–ê–ù–ù–ê–Ø –ù–ò–®–ê (–≤—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∞, —Ç—Ä–µ–±—É–µ—Ç —Å–º–µ–ª–æ—Å—Ç–∏)
- –í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ({profile.risk_tolerance}/10)
- –ß–µ—Ç–∫–∏–π –ø–ª–∞–Ω –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤
- –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

### 8. üéØ –°–ö–†–´–¢–ê–Ø –ù–ò–®–ê (–º–∞–ª–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ù–µ–æ—á–µ–≤–∏–¥–Ω–∞—è –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è
- –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è
- –¢—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã

## –§–û–†–ú–ê–¢ –î–õ–Ø –ö–ê–ñ–î–û–ô –ù–ò–®–ò (—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è):

–ù–ò–®–ê 1: [–¢–ò–ü]
–ù–ê–ó–í–ê–ù–ò–ï: [–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, 3-5 —Å–ª–æ–≤]
–°–£–¢–¨: [–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞—Ç—å, 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]
–ü–û–ß–ï–ú–£ –ü–û–î–•–û–î–ò–¢: [–°–≤—è–∑—å —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ]
–§–û–†–ú–ê–¢: [–æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω/–≥–∏–±—Ä–∏–¥]
–ò–ù–í–ï–°–¢–ò–¶–ò–ò: [–î–∏–∞–ø–∞–∑–æ–Ω –≤ —Ä—É–±–ª—è—Ö]
–°–†–û–ö –û–ö–£–ü–ê–ï–ú–û–°–¢–ò: [–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ä–æ–∫]
–ü–ï–†–í–´–ï 3 –®–ê–ì–ê: 
1. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
2. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]
3. [–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ]

–í–ï–†–ù–ò –¢–û–õ–¨–ö–û 8 –ù–ò–® –í –≠–¢–û–ú –§–û–†–ú–ê–¢–ï. –ë–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, –±–µ–∑ –∑–∞–∫–ª—é—á–µ–Ω–∏–π."""

    def create_detailed_plan_prompt(self, profile: UserProfile, niche: Dict) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
        return f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –∫–æ—É—á.
–°–æ–∑–¥–∞–π –ì–ò–ü–ï–†–ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ë–ò–ó–ù–ï–°-–ü–õ–ê–ù.

## –ù–ò–®–ê –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ò:
{niche.get('name', '')} ({niche.get('type', '')})
{niche.get('description', '')}

## –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã):
- –í–æ–∑—Ä–∞—Å—Ç: {profile.age_group}
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: {profile.education}
- –õ–æ–∫–∞—Ü–∏—è: {profile.custom_location or profile.location}
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è: {', '.join(profile.motivation)}
- –ì–ª–∞–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏: {', '.join(profile.fears_selected)}
- –ë—é–¥–∂–µ—Ç: {profile.budget}
- –í—Ä–µ–º—è –≤ –Ω–µ–¥–µ–ª—é: {profile.time_per_week}
- –°—É–ø–µ—Ä—Å–∏–ª–∞: {profile.superpower}
- –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ø–∏–∫: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞={profile.energy_analytical}, –ö—Ä–µ–∞—Ç–∏–≤={profile.energy_creative}

## –û–°–û–ë–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –£–ß–ï–°–¢–¨ –í–û–ó–†–ê–°–¢ {profile.age_group} - –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–º–ø –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å
2. –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –û–ë–†–ê–ó–û–í–ê–ù–ò–ï {profile.education} - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å
3. –£–ß–ï–°–¢–¨ –õ–û–ö–ê–¶–ò–Æ {profile.location} - –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–µ—Å—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
4. –û–ë–û–ô–¢–ò –°–¢–†–ê–•–ò: {', '.join(profile.fears_selected)} - –¥–æ–±–∞–≤–∏—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏
5. –£–õ–û–ñ–ò–¢–¨–°–Ø –í {profile.time_per_week} –ß–ê–°–û–í –í –ù–ï–î–ï–õ–Æ - —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
6. –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –°–£–ü–ï–†–°–ò–õ–£ {profile.superpower} - —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ–º

## –°–¢–†–£–ö–¢–£–†–ê –ü–õ–ê–ù–ê:

### 1. üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê (–¥–µ–Ω—å 1-7)
- –ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —ç—Ç–æ–π –Ω–∏—à–∏
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã –∏ –ø—Ä–∏–≤—ã—á–∫–∏
- –¢–µ—Ö–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 2. üöÄ –ü–û–®–ê–ì–û–í–´–ô –ó–ê–ü–£–°–ö (30 –¥–Ω–µ–π, –ø–æ –¥–Ω—è–º)
#### –ù–µ–¥–µ–ª—è 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –¥–Ω—è–º)
#### –ù–µ–¥–µ–ª—è 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤ (—Å–∞–π—Ç, —Å–æ—Ü—Å–µ—Ç–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—ã)
#### –ù–µ–¥–µ–ª—è 3: –ü–µ—Ä–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏
#### –ù–µ–¥–µ–ª—è 4: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞

### 3. üí∞ –§–ò–ù–ê–ù–°–û–í–ê–Ø –î–û–†–û–ñ–ù–ê–Ø –ö–ê–†–¢–ê (12 –º–µ—Å—è—Ü–µ–≤)
#### –ú–µ—Å—è—Ü 1-3: –í—ã—Ö–æ–¥ –≤ –Ω–æ–ª—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤)
#### –ú–µ—Å—è—Ü 4-6: –î–æ—Ö–æ–¥ 50,000‚ÇΩ –≤ –º–µ—Å—è—Ü (–∫–∞–∫ –¥–æ—Å—Ç–∏—á—å, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏)
#### –ú–µ—Å—è—Ü 7-12: –î–æ—Ö–æ–¥ 100,000‚ÇΩ –≤ –º–µ—Å—è—Ü (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è)
#### –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (–¥–µ—Ç–∞–ª—å–Ω–æ)

### 4. üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê –ò KPI
- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (3 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
- –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (3 –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è

### 5. ‚ö†Ô∏è –ß–ï–ö-–õ–ò–°–¢ –û–®–ò–ë–û–ö –ò –†–ï–®–ï–ù–ò–ô
- –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –Ω–æ–≤–∏—á–∫–æ–≤ –≤ —ç—Ç–æ–π –Ω–∏—à–µ (5-7 –æ—à–∏–±–æ–∫)
- –ö–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏—Ö –∑–∞—Ä–∞–Ω–µ–µ
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–∏
- –ü–ª–∞–Ω –ë –Ω–∞ —Å–ª—É—á–∞–π —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### 6. üìö –†–ï–°–£–†–°–´ –î–õ–Ø –†–û–°–¢–ê –ò –†–ê–ó–í–ò–¢–ò–Ø
- –ö–Ω–∏–≥–∏ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –ø–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥—è—Ç)
- –ö—É—Ä—Å—ã (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, —Å —Å—Å—ã–ª–∫–∞–º–∏ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
- –°–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥ (–≥–¥–µ –∏—Å–∫–∞—Ç—å)
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Å–æ—Ñ—Ç (—Å–ø–∏—Å–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º)

–°–¥–µ–ª–∞–π –ø–ª–∞–Ω –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ö–û–ù–ö–†–ï–¢–ù–´–ú, —Å —Ü–∏—Ñ—Ä–∞–º–∏, —Å—Ä–æ–∫–∞–º–∏, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.
–£—á–∏—Ç—ã–≤–∞–π –≤—Å–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è."""

    async def call_openai(self, prompt: str, temperature: float = 0.7, max_tokens: int = 3000) -> Optional[str]:
        """–í—ã–∑–æ–≤ OpenAI API"""
        if not self.is_available:
            logger.warning("OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return None
        
        try:
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }
            
            data = {
                "model": "gpt-4-turbo-preview",
                "messages": [
                    {"role": "system", "content": "–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫."},
                    {"role": "user", "content": prompt}
                ],
                "temperature": temperature,
                "max_tokens": max_tokens
            }
            
            response = requests.post(
                "https://api.openai.com/v1/chat/completions",
                headers=headers,
                json=data,
                timeout=60
            )
            
            if response.status_code == 200:
                result = response.json()
                content = result["choices"][0]["message"]["content"]
                
                # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
                usage = result.get("usage", {})
                prompt_tokens = usage.get("prompt_tokens", 0)
                completion_tokens = usage.get("completion_tokens", 0)
                
                chat_memory.token_usage.add_usage(prompt_tokens, completion_tokens)
                
                logger.info(f"‚úÖ OpenAI: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ {completion_tokens} —Ç–æ–∫–µ–Ω–æ–≤ (–≤—Å–µ–≥–æ: {chat_memory.token_usage.total_tokens})")
                return content
            else:
                logger.error(f"‚ùå OpenAI –æ—à–∏–±–∫–∞: {response.status_code}")
                return None
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ OpenAI: {e}")
            return None
    
    async def generate_psychological_analysis(self, profile: UserProfile) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        logger.info(f"üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {profile.user_id}")
        
        prompt = self.create_analysis_prompt(profile)
        analysis = await self.call_openai(prompt, temperature=0.5, max_tokens=2000)
        
        if analysis:
            logger.info(f"‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω ({len(analysis)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            logger.warning("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑")
            analysis = self.create_fallback_analysis(profile)
        
        return analysis
    
    async def generate_business_niches(self, profile: UserProfile, analysis: str) -> Optional[List[Dict]]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–Ω–∏—à"""
        logger.info(f"üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–Ω–∏—à –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {profile.user_id}")
        
        prompt = self.create_niches_prompt(profile, analysis)
        niches_text = await self.call_openai(prompt, temperature=0.8, max_tokens=4000)
        
        if not niches_text:
            logger.warning("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∏—à–∏")
            return self.create_fallback_niches(profile)
        
        # –ü–∞—Ä—Å–∏–Ω–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∏—à
        niches = self.parse_niches_from_text(niches_text)
        
        if niches:
            logger.info(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(niches)} –Ω–∏—à")
        else:
            logger.warning("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –Ω–∏—à–∏")
            niches = self.create_fallback_niches(profile)
        
        return niches
    
    async def generate_detailed_plan(self, profile: UserProfile, niche: Dict) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
        logger.info(f"üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –¥–ª—è –Ω–∏—à–∏: {niche.get('name', '')}")
        
        prompt = self.create_detailed_plan_prompt(profile, niche)
        plan = await self.call_openai(prompt, temperature=0.6, max_tokens=4000)
        
        if not plan:
            logger.warning("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω")
            plan = self.create_fallback_plan(profile, niche)
        
        return plan
    
    def parse_niches_from_text(self, text: str) -> List[Dict]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –Ω–∏—à –∏–∑ —Ç–µ–∫—Å—Ç–∞ OpenAI"""
        niches = []
        current_niche = {}
        
        lines = text.strip().split('\n')
        
        for line in lines:
            line = line.strip()
            
            if line.startswith('–ù–ò–®–ê'):
                if current_niche:
                    niches.append(current_niche.copy())
                current_niche = {'id': len(niches) + 1}
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–∏–ø –∏–∑ –ù–ò–®–ê X: [–¢–ò–ü]
                match = re.search(r'–ù–ò–®–ê\s+\d+:\s*(.+?)$', line)
                if match:
                    current_niche['type'] = match.group(1).strip()
            
            elif line.startswith('–ù–ê–ó–í–ê–ù–ò–ï:'):
                current_niche['name'] = line.replace('–ù–ê–ó–í–ê–ù–ò–ï:', '').strip()
            
            elif line.startswith('–°–£–¢–¨:'):
                current_niche['description'] = line.replace('–°–£–¢–¨:', '').strip()
            
            elif line.startswith('–ü–û–ß–ï–ú–£ –ü–û–î–•–û–î–ò–¢:'):
                current_niche['why'] = line.replace('–ü–û–ß–ï–ú–£ –ü–û–î–•–û–î–ò–¢:', '').strip()
            
            elif line.startswith('–§–û–†–ú–ê–¢:'):
                current_niche['format'] = line.replace('–§–û–†–ú–ê–¢:', '').strip()
            
            elif line.startswith('–ò–ù–í–ï–°–¢–ò–¶–ò–ò:'):
                current_niche['investment'] = line.replace('–ò–ù–í–ï–°–¢–ò–¶–ò–ò:', '').strip()
            
            elif line.startswith('–°–†–û–ö –û–ö–£–ü–ê–ï–ú–û–°–¢–ò:'):
                current_niche['roi'] = line.replace('–°–†–û–ö –û–ö–£–ü–ê–ï–ú–û–°–¢–ò:', '').strip()
            
            elif line.startswith('–ü–ï–†–í–´–ï 3 –®–ê–ì–ê:'):
                current_niche['steps'] = []
            elif line.startswith('1.') and 'steps' in current_niche:
                current_niche['steps'].append(line[2:].strip())
            elif line.startswith('2.') and 'steps' in current_niche:
                current_niche['steps'].append(line[2:].strip())
            elif line.startswith('3.') and 'steps' in current_niche:
                current_niche['steps'].append(line[2:].strip())
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–∏—à—É
        if current_niche:
            niches.append(current_niche)
        
        # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 3 —à–∞–≥–∞
        for niche in niches:
            if 'steps' not in niche or len(niche['steps']) < 3:
                niche['steps'] = [
                    '–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤',
                    '–°–æ–∑–¥–∞—Ç—å MVP –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏',
                    '–ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã—Ö 3 –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'
                ]
        
        return niches
    
    def create_fallback_analysis(self, profile: UserProfile) -> str:
        """–ó–∞–ø–∞—Å–Ω–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑"""
        return f"""# –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó (–±–∞–∑–æ–≤—ã–π)

## 1. –ö–õ–Æ–ß–ï–í–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
- **–¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏:** –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º
- **–ú–æ—Ç–∏–≤–∞—Ü–∏—è:** {', '.join(profile.motivation)}
- **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:** –•–æ—Ä–æ—à–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ ({profile.skills_analytics}/5), —É–º–µ–Ω–∏–µ –æ–±—â–∞—Ç—å—Å—è ({profile.skills_communication}/5)
- **–≠–Ω–µ—Ä–≥–∏—è:** –ü–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ - {profile.energy_analytical or '–¥–Ω–µ–≤–Ω–æ–µ'} –≤—Ä–µ–º—è

## 2. –°–ö–†–´–¢–´–ô –ü–û–¢–ï–ù–¶–ò–ê–õ:
- –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ + {profile.superpower or '–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å'}
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: {profile.education}
- –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: {profile.custom_location or profile.location}

## 3. –ò–î–ï–ê–õ–¨–ù–´–ï –£–°–õ–û–í–ò–Ø:
- –§–æ—Ä–º–∞—Ç: {profile.business_format or '–≥–∏–±—Ä–∏–¥'}
- –¢–µ–º–ø: –£–º–µ—Ä–µ–Ω–Ω—ã–π, —Å –±—ã—Å—Ç—Ä—ã–º —Å—Ç–∞—Ä—Ç–æ–º
- –ö–ª–∏–µ–Ω—Ç—ã: {profile.ideal_client_age or '30-40 –ª–µ—Ç'}, {profile.ideal_client_field or '–±–∏–∑–Ω–µ—Å'}

## 4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
1. –ù–∞—á–∏–Ω–∞—Ç—å —Å –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
3. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –º–∞—Å—à—Ç–∞–± –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏"""
    
    def create_fallback_niches(self, profile: UserProfile) -> List[Dict]:
        """–ó–∞–ø–∞—Å–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–Ω–∏—à–∏"""
        location = profile.custom_location or profile.location or "–≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ"
        
        return [
            {
                'id': 1,
                'type': 'üî• –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç',
                'name': '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏',
                'description': f'–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –≤ –≤–∞—à–µ–π —Å—Ñ–µ—Ä–µ –∑–Ω–∞–Ω–∏–π –±–∏–∑–Ω–µ—Å–∞–º –≤ {location}',
                'why': '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞—à–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
                'format': '–ì–∏–±—Ä–∏–¥',
                'investment': '10,000-50,000‚ÇΩ',
                'roi': '1-2 –º–µ—Å—è—Ü–∞',
                'steps': [
                    '–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å 3 –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π',
                    '–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                    '–ù–∞–π—Ç–∏ 5 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ LinkedIn'
                ]
            },
            {
                'id': 2,
                'type': 'üöÄ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π',
                'name': '–û–Ω–ª–∞–π–Ω-–æ–±—É—á–µ–Ω–∏–µ',
                'description': '–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–∞–∂–∞ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–æ–≤ –ø–æ –≤–∞—à–µ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ',
                'why': '–°–æ—á–µ—Ç–∞–µ—Ç –≤–∞—à–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∂–µ–ª–∞–Ω–∏–µ –¥–µ–ª–∏—Ç—å—Å—è –∑–Ω–∞–Ω–∏—è–º–∏',
                'format': '–û–Ω–ª–∞–π–Ω',
                'investment': '50,000-100,000‚ÇΩ',
                'roi': '3-4 –º–µ—Å—è—Ü–∞',
                'steps': [
                    '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –º–∏–Ω–∏-–∫—É—Ä—Å–∞',
                    '–°–æ–∑–¥–∞—Ç—å 3 –ø—Ä–æ–±–Ω—ã—Ö —É—Ä–æ–∫–∞',
                    '–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–¥–∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ —Å–æ—Ü—Å–µ—Ç–∏'
                ]
            },
            {
                'id': 3,
                'type': 'üå± –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π',
                'name': '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤',
                'description': f'–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –≤ {location}',
                'why': '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º',
                'format': '–ì–∏–±—Ä–∏–¥',
                'investment': '100,000-200,000‚ÇΩ',
                'roi': '6-8 –º–µ—Å—è—Ü–µ–≤',
                'steps': [
                    '–ò–∑—É—á–∏—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ CRM —Å–∏—Å—Ç–µ–º—ã',
                    '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å 3 –ø–∞–∫–µ—Ç–∞ —É—Å–ª—É–≥ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏',
                    '–ü—Ä–æ–≤–µ—Å—Ç–∏ 10 –ø—Ä–æ–±–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π'
                ]
            },
            {
                'id': 4,
                'type': 'üíé –†–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π',
                'name': '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø',
                'description': '–°–æ–∑–¥–∞–Ω–∏–µ SaaS-–ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã —Ä—ã–Ω–∫–∞',
                'why': '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã—Å–æ–∫–æ–º—É —É—Ä–æ–≤–Ω—é —Ä–∏—Å–∫–∞ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –Ω–∞–≤—ã–∫–∞–º',
                'format': '–û–Ω–ª–∞–π–Ω',
                'investment': '300,000-500,000‚ÇΩ',
                'roi': '12-18 –º–µ—Å—è—Ü–µ–≤',
                'steps': [
                    '–ü—Ä–æ–≤–µ—Å—Ç–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞',
                    '–ù–∞–π—Ç–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ—Å–Ω–æ–≤–∞—Ç–µ–ª—è',
                    '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø –ø—Ä–æ–¥—É–∫—Ç–∞'
                ]
            },
            {
                'id': 5,
                'type': 'üéØ –°–∫—Ä—ã—Ç–∞—è –Ω–∏—à–∞',
                'name': '–ù–∏—à–µ–≤–æ–µ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
                'description': f'–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è —É–∑–∫–æ–π –æ—Ç—Ä–∞—Å–ª–∏ –≤ {location}',
                'why': '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è',
                'format': profile.business_format or '–ì–∏–±—Ä–∏–¥',
                'investment': '20,000-80,000‚ÇΩ',
                'roi': '2-3 –º–µ—Å—è—Ü–∞',
                'steps': [
                    '–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É–∑–∫—É—é —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é',
                    '–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                    '–ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥'
                ]
            }
        ]
    
    def create_fallback_plan(self, profile: UserProfile, niche: Dict) -> str:
        """–ó–∞–ø–∞—Å–Ω–æ–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω"""
        return f"""# üìã –î–ï–¢–ê–õ–¨–ù–´–ô –ë–ò–ó–ù–ï–°-–ü–õ–ê–ù

## üéØ –ù–ò–®–ê: {niche.get('name', '–ë–∏–∑–Ω–µ—Å-—É—Å–ª—É–≥–∏')}

### 1. üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –ü–û–î–ì–û–¢–û–í–ö–ê (–Ω–µ–¥–µ–ª—è 1)
- **–ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:** –ï–∂–µ–¥–Ω–µ–≤–Ω–æ 15 –º–∏–Ω—É—Ç –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —É—Å–ø–µ—Ö–∞
- **–†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–∞—Ö–∞–º–∏:** –†–∞–∑–±–∏–≤–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –ø–æ 30 –º–∏–Ω—É—Ç
- **–†–∏—Ç—É–∞–ª—ã:** –£—Ç—Ä–µ–Ω–Ω–∏–π planning –∏ –≤–µ—á–µ—Ä–Ω–∏–π review –¥–Ω—è

### 2. üöÄ 30-–î–ù–ï–í–ù–´–ô –ó–ê–ü–£–°–ö
**–ù–µ–¥–µ–ª—è 1-2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**
- –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–≤–∏–∑–∏—Ç–∫–∞, —Å–∞–π—Ç, —Å–æ—Ü—Å–µ—Ç–∏)
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏ —Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
- –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ

**–ù–µ–¥–µ–ª—è 3-4: –ü–µ—Ä–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã**
- –ù–∞–π—Ç–∏ 20 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Å—Ç–∏ 5 –ø—Ä–æ–±–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
- –ó–∞–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–≤—ã–µ 2-3 –¥–æ–≥–æ–≤–æ—Ä–∞

### 3. üí∞ –§–ò–ù–ê–ù–°–û–í–ê–Ø –î–û–†–û–ñ–ù–ê–Ø –ö–ê–†–¢–ê
**–°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:** {niche.get('investment', '50,000-100,000‚ÇΩ')}

**–ú–µ—Å—è—Ü 1-3:**
- –î–æ—Ö–æ–¥: 30,000-50,000‚ÇΩ
- –†–∞—Å—Ö–æ–¥—ã: 20,000-30,000‚ÇΩ
- **–¶–µ–ª—å:** –í—ã–π—Ç–∏ –≤ –Ω–æ–ª—å –∫ –∫–æ–Ω—Ü—É 3 –º–µ—Å—è—Ü–∞

**–ú–µ—Å—è—Ü 4-6:**
- –î–æ—Ö–æ–¥: 50,000-80,000‚ÇΩ
- **–¶–µ–ª—å:** –°—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ 50,000‚ÇΩ –≤ –º–µ—Å—è—Ü

**–ú–µ—Å—è—Ü 7-12:**
- –î–æ—Ö–æ–¥: 80,000-120,000‚ÇΩ
- **–¶–µ–ª—å:** –î–æ—Å—Ç–∏—á—å 100,000‚ÇΩ –≤ –º–µ—Å—è—Ü

### 4. üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê
- **–ï–∂–µ–¥–Ω–µ–≤–Ω–æ:** 3 –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–∞, 1 –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
- **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ:** 2-3 –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏
- **–ï–∂–µ–º–µ—Å—è—á–Ω–æ:** –î–æ—Ö–æ–¥ –æ—Ç 50,000‚ÇΩ, 5 –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### 5. ‚ö†Ô∏è –¢–ò–ü–ò–ß–ù–´–ï –û–®–ò–ë–ö–ò
1. **–°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π —Ñ–æ–∫–æ—Å:** –ù–∞—á–∏–Ω–∞—Ç—å –Ω—É–∂–Ω–æ —Å —É–∑–∫–æ–π –Ω–∏—à–∏
2. **–ù–µ–¥–æ–æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏—Å—Ç–µ–º—ã:** –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è

### 6. üìö –†–ï–°–£–†–°–´ –î–õ–Ø –†–û–°–¢–ê
- **–ö–Ω–∏–≥–∏:** "–û—Ç –Ω—É–ª—è –∫ –µ–¥–∏–Ω–∏—Ü–µ" –ü–∏—Ç–µ—Ä –¢–∏–ª—å, "–ë–∏–∑–Ω–µ—Å —Å –Ω—É–ª—è" –≠—Ä–∏–∫ –†–∏—Å
- **–°–æ–æ–±—â–µ—Å—Ç–≤–∞:** –ú–µ—Å—Ç–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–∫–ª—É–±—ã, Telegram-—á–∞—Ç—ã –ø–æ –≤–∞—à–µ–π —Ç–µ–º–µ
- **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:** Notion –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, Canva –¥–ª—è –¥–∏–∑–∞–π–Ω–∞, Tilda –¥–ª—è —Å–∞–π—Ç–∞

üí° **–°–æ–≤–µ—Ç:** –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –º–∞–ª–æ–≥–æ, –±—ã—Å—Ç—Ä–æ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã, —Å–æ–±–∏—Ä–∞–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ —Ç–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç."""

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ OpenAI
openai_service = OpenAIService()

# ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
def get_random_praise() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É –ø–æ—Ö–≤–∞–ª—ã"""
    return random.choice(PRAISE_PHRASES)

def get_memory_status() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–∞–º—è—Ç–∏"""
    memory_percent = chat_memory.get_memory_usage_percentage()
    token_percent = chat_memory.token_usage.get_percentage_used()
    
    memory_bar = "üü¢" * int(memory_percent / 10) + "‚ö™" * (10 - int(memory_percent / 10))
    token_bar = chat_memory.token_usage.get_usage_bar()
    
    return (
        f"\n\nüíæ *–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:*\n"
        f"‚Ä¢ –ü–∞–º—è—Ç—å: {memory_bar} {memory_percent:.1f}%\n"
        f"‚Ä¢ –¢–æ–∫–µ–Ω—ã AI: {token_bar}\n"
        f"‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${chat_memory.token_usage.estimated_cost:.4f}"
    )

def split_text(text: str, max_length: int = 4000) -> List[str]:
    """–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞—Å—Ç–∏"""
    if len(text) <= max_length:
        return [text]
    
    parts = []
    while len(text) > max_length:
        split_pos = text.rfind('\n', 0, max_length)
        if split_pos == -1:
            split_pos = text.rfind('. ', 0, max_length)
        if split_pos == -1:
            split_pos = text.rfind(' ', 0, max_length)
        if split_pos == -1:
            split_pos = max_length
        
        parts.append(text[:split_pos].strip())
        text = text[split_pos:].strip()
    
    if text:
        parts.append(text)
    
    return parts

def format_niche_for_display(niche: Dict, index: int, total: int) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏—à–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    return f"""üéØ *–ù–ò–®–ê {index} –∏–∑ {total}*

{niche.get('type', 'üî• –ù–∏—à–∞')}

*{niche.get('name', '–ù–∞–∑–≤–∞–Ω–∏–µ')}*

üìù *–°—É—Ç—å:*
{niche.get('description', '–û–ø–∏—Å–∞–Ω–∏–µ')}

‚úÖ *–ü–æ—á–µ–º—É –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç:*
{niche.get('why', '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é')}

üìä *–î–µ—Ç–∞–ª–∏:*
‚Ä¢ –§–æ—Ä–º–∞—Ç: {niche.get('format', '–ì–∏–±—Ä–∏–¥')}
‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: {niche.get('investment', '50,000-100,000‚ÇΩ')}
‚Ä¢ –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å: {niche.get('roi', '3-6 –º–µ—Å—è—Ü–µ–≤')}

üöÄ *–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏:*
1. {niche.get('steps', [''])[0] if niche.get('steps') else '–ù–∞—á–∞—Ç—å —Å –∞–Ω–∞–ª–∏–∑–∞ —Ä—ã–Ω–∫–∞'}
2. {niche.get('steps', [''])[1] if len(niche.get('steps', [])) > 1 else '–°–æ–∑–¥–∞—Ç—å MVP'}
3. {niche.get('steps', [''])[2] if len(niche.get('steps', [])) > 2 else '–ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤'}"""

# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    chat = update.effective_chat
    
    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
    now = datetime.now()
    expired_users = [
        user_id for user_id, profile in chat_memory.user_profiles.items()
        if (now - profile.last_activity).total_seconds() > 86400
    ]
    for user_id in expired_users:
        del chat_memory.user_profiles[user_id]
    
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
    if user.id in chat_memory.user_profiles:
        profile = chat_memory.user_profiles[user.id]
        profile.last_activity = now
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ
        profile.current_question = 0
        profile.questions_answered = 0
    else:
        profile = UserProfile(
            user_id=user.id,
            chat_id=chat.id
        )
        chat_memory.user_profiles[user.id] = profile
    
    chat_memory.total_messages += 1
    profile.last_activity = now
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ai_status = "‚úÖ (AI-—Ä–µ–∂–∏–º)" if openai_service.is_available else "‚ö†Ô∏è (–ë–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º)"
    
    welcome_text = (
        f"üëã *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä 6.0!* {ai_status}\n\n"
        "üéØ *–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:*\n"
        "‚Ä¢ 18 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ª–∏—á–Ω–æ—Å—Ç–∏\n"
        "‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç –æ—Ç AI\n"
        "‚Ä¢ 8 –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–Ω–∏—à\n"
        "‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –ø–ª–∞–Ω—ã\n\n"
        "‚è±Ô∏è *–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è:* 15-20 –º–∏–Ω—É—Ç\n"
        "üìä *–ì–ª—É–±–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞:* –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å"
    )
    
    welcome_text += get_memory_status()
    
    keyboard = [[InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∞–Ω–∫–µ—Ç—É", callback_data='start_questionnaire')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')
    
    return BotState.DEMOGRAPHY

# ==================== –î–û–ü–û–õ–ù–ï–ù–ò–ï –ù–ï–î–û–°–¢–ê–Æ–©–ò–• –ß–ê–°–¢–ï–ô ====================

async def handle_learning_distribution(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –æ–±—É—á–µ–Ω–∏—è (–≤–æ–ø—Ä–æ—Å 12)"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    if query.data == 'learning_done':
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ 10 –±–∞–ª–ª–æ–≤
        total_points = (profile.learning_practice + profile.learning_books + 
                       profile.learning_courses + profile.learning_group + 
                       profile.learning_observation)
        
        if total_points == 10:
            profile.questions_answered += 1
            profile.current_question += 1
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —ç–∫–∑–∏—Å—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É
            memory_status = get_memory_status()
            
            await query.edit_message_text(
                f"{get_random_praise()} –°—Ç–∏–ª—å –æ–±—É—á–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!\n\n"
                f"üåç *–í–æ–ø—Ä–æ—Å 14/18: –≠–ö–ó–ò–°–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ô –í–û–ü–†–û–°*\n\n"
                "–ó–ê–î–ê–ù–ò–ï –ù–ê 2 –ú–ò–ù–£–¢–´ –†–ê–ó–ú–´–®–õ–ï–ù–ò–Ø:\n\n"
                "\"–ï—Å–ª–∏ –±—ã –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏\n"
                "–∏ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –±—ã–ª–∏ –±—ã —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω—ã...\"\n\n"
                "–ß–ï–ú –ë–´ –í–´ –ó–ê–ù–ò–ú–ê–õ–ò–°–¨?\n\n"
                "–û–ø–∏—à–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.\n"
                "–ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å, –ø–æ–¥—É–º–∞–π—Ç–µ —Ö–æ—Ä–æ—à–æ."
                f"{memory_status}",
                parse_mode='Markdown'
            )
            
            return BotState.VALUES
        else:
            await query.answer(f"‚ùå –ù—É–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å 10 –±–∞–ª–ª–æ–≤! –°–µ–π—á–∞—Å: {total_points}/10", show_alert=True)
            return await ask_learning_distribution(update, context)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
    if query.data.startswith('learning_'):
        action, method = query.data.split('_')[1:3]
        
        if action == 'inc':
            if profile.learning_points_assigned < 10:
                if method == 'practice':
                    profile.learning_practice += 1
                elif method == 'books':
                    profile.learning_books += 1
                elif method == 'courses':
                    profile.learning_courses += 1
                elif method == 'group':
                    profile.learning_group += 1
                elif method == 'observation':
                    profile.learning_observation += 1
                profile.learning_points_assigned += 1
        
        elif action == 'dec':
            if method == 'practice' and profile.learning_practice > 0:
                profile.learning_practice -= 1
                profile.learning_points_assigned -= 1
            elif method == 'books' and profile.learning_books > 0:
                profile.learning_books -= 1
                profile.learning_points_assigned -= 1
            elif method == 'courses' and profile.learning_courses > 0:
                profile.learning_courses -= 1
                profile.learning_points_assigned -= 1
            elif method == 'group' and profile.learning_group > 0:
                profile.learning_group -= 1
                profile.learning_points_assigned -= 1
            elif method == 'observation' and profile.learning_observation > 0:
                profile.learning_observation -= 1
                profile.learning_points_assigned -= 1
    
    return await ask_learning_distribution(update, context)

async def ask_learning_distribution(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–ø—Ä–æ—Å –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤ –æ–±—É—á–µ–Ω–∏—è"""
    user_id = update.callback_query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
    keyboard = []
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    keyboard.append([InlineKeyboardButton("üìö –†–ê–°–ü–†–ï–î–ï–õ–ò–¢–ï 10 –ë–ê–õ–õ–û–í:", callback_data='learning_title')])
    
    # –ú–µ—Ç–æ–¥—ã –æ–±—É—á–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ +/-
    learning_methods = [
        ("–ü—Ä–∞–∫—Ç–∏–∫–∞, –ø—Ä–æ–± –∏ –æ—à–∏–±–∫–∞", 'practice', profile.learning_practice),
        ("–ö–Ω–∏–≥–∏, —Ç–µ–æ—Ä–∏—è", 'books', profile.learning_books),
        ("–ö—É—Ä—Å—ã —Å –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–º", 'courses', profile.learning_courses),
        ("–û–±—É—á–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ", 'group', profile.learning_group),
        ("–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏", 'observation', profile.learning_observation)
    ]
    
    for method_name, method_key, current_points in learning_methods:
        row = [
            InlineKeyboardButton("‚ûñ", callback_data=f'learning_dec_{method_key}'),
            InlineKeyboardButton(f"{method_name}: {current_points}", callback_data=f'learning_info_{method_key}'),
            InlineKeyboardButton("‚ûï", callback_data=f'learning_inc_{method_key}')
        ]
        keyboard.append(row)
    
    # –°—Ç—Ä–æ–∫–∞ —Å –∏—Ç–æ–≥–æ–º
    total_points = sum([p[2] for p in learning_methods])
    keyboard.append([InlineKeyboardButton(f"üéØ –ò–¢–û–ì–û: {total_points}/10 –±–∞–ª–ª–æ–≤", callback_data='learning_total')])
    
    # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    keyboard.append([InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", callback_data='learning_done')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    memory_status = get_memory_status()
    
    text = (
        f"{get_random_praise()} –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!\n\n"
        f"üìö *–í–æ–ø—Ä–æ—Å 13/18: –°–¢–ò–õ–¨ –û–ë–£–ß–ï–ù–ò–Ø*\n\n"
        "–ö–ê–ö –í–´ –õ–£–ß–®–ï –í–°–ï–ì–û –£–ß–ò–¢–ï–°–¨ –ù–û–í–û–ú–£?\n\n"
        "–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ 10 –±–∞–ª–ª–æ–≤ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –æ–±—É—á–µ–Ω–∏—è:\n"
        "(–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‚ûñ –∏ ‚ûï –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–ª–æ–≤)\n\n"
        f"‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {total_points}/10 –±–∞–ª–ª–æ–≤"
        f"{memory_status}"
    )
    
    await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    
    return BotState.SKILLS

# –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –Ω–∞–≤—ã–∫–∞—Ö...
async def handle_work_style(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∏–ª—è —Ä–∞–±–æ—Ç—ã"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    work_map = {
        'work_alone': '–í –æ–¥–∏–Ω–æ—á–∫—É - –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å',
        'work_pair': '–í –ø–∞—Ä–µ - –≤–∑–∞–∏–º–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
        'work_team': '–í –∫–æ–º–∞–Ω–¥–µ 3-5 —á–µ–ª–æ–≤–µ–∫',
        'work_structure': '–í —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å —á–µ—Ç–∫–∏–º–∏ —Ä–æ–ª—è–º–∏',
        'work_remote': '–£–¥–∞–ª–µ–Ω–Ω–æ, —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º–∏ –≤—Å—Ç—Ä–µ—á–∞–º–∏',
        'work_flexible': '–ì–∏–±–∫–æ - –º–µ–Ω—è—é —Ñ–æ—Ä–º–∞—Ç—ã –ø–æ–¥ –∑–∞–¥–∞—á–∏'
    }
    
    profile.work_style = work_map.get(query.data, '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
    profile.questions_answered += 1
    profile.current_question += 1
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –±–∞–ª–ª–æ–≤ –æ–±—É—á–µ–Ω–∏—è
    return await ask_learning_distribution(update, context)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –Ω–∞–≤—ã–∫–æ–≤
async def handle_skill_design(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ü–µ–Ω–∫–∏ –¥–∏–∑–∞–π–Ω–∞"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    if query.data == 'skill_design_next':
        profile.current_question += 1
        return await ask_skills_organization(update, context)
    
    if query.data.startswith('skill_design_'):
        level = int(query.data.split('_')[2])
        profile.skills_design = level
        return await ask_skills_design(update, context)

async def ask_skills_design(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–ø—Ä–æ—Å –æ –Ω–∞–≤—ã–∫–µ –¥–∏–∑–∞–π–Ω–∞"""
    user_id = update.callback_query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    keyboard = []
    for i in range(1, 6):
        if i == profile.skills_design:
            keyboard.append([InlineKeyboardButton(f"üé® {i} –∏–∑ 5 (—Ç–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞)", callback_data=f'skill_design_{i}')])
        else:
            keyboard.append([InlineKeyboardButton(f"{i}", callback_data=f'skill_design_{i}')])
    
    keyboard.append([InlineKeyboardButton("‚ñ∂Ô∏è –î–∞–ª–µ–µ", callback_data='skill_design_next')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    memory_status = get_memory_status()
    
    text = (
        f"{get_random_praise()} –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –æ—Ü–µ–Ω–µ–Ω–∞!\n\n"
        f"üé® *–í–æ–ø—Ä–æ—Å 11/18: –î–ò–ó–ê–ô–ù/–ö–†–ï–ê–¢–ò–í*\n\n"
        "–î–ò–ó–ê–ô–ù/–ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ (—Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–∏–∑–∞–π–Ω, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è)\n\n"
        "–û—Ü–µ–Ω–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ 5-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ:\n"
        "1 - –Ω–∞—á–∏–Ω–∞—é—â–∏–π, 5 - —ç–∫—Å–ø–µ—Ä—Ç\n\n"
        f"–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞: *{profile.skills_design} –∏–∑ 5*"
        f"{memory_status}"
    )
    
    await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    
    return BotState.SKILLS

# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏: organization, manual, eq
# –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –ø–æ–∫–∞–∂—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏

async def ask_skills_organization(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–ø—Ä–æ—Å –æ –Ω–∞–≤—ã–∫–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"""
    user_id = update.callback_query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    keyboard = []
    for i in range(1, 6):
        if i == profile.skills_organization:
            keyboard.append([InlineKeyboardButton(f"üìä {i} –∏–∑ 5 (—Ç–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞)", callback_data=f'skill_org_{i}')])
        else:
            keyboard.append([InlineKeyboardButton(f"{i}", callback_data=f'skill_org_{i}')])
    
    keyboard.append([InlineKeyboardButton("‚ñ∂Ô∏è –î–∞–ª–µ–µ", callback_data='skill_org_next')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    memory_status = get_memory_status()
    
    text = (
        f"{get_random_praise()} –î–∏–∑–∞–π–Ω –æ—Ü–µ–Ω–µ–Ω!\n\n"
        f"üìä *–í–æ–ø—Ä–æ—Å 12/18: –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø*\n\n"
        "–û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø/–ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏, —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç, —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å)\n\n"
        "–û—Ü–µ–Ω–∏—Ç–µ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ 5-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ:\n"
        "1 - –Ω–∞—á–∏–Ω–∞—é—â–∏–π, 5 - —ç–∫—Å–ø–µ—Ä—Ç\n\n"
        f"–¢–µ–∫—É—â–∞—è –æ—Ü–µ–Ω–∫–∞: *{profile.skills_organization} –∏–∑ 5*"
        f"{memory_status}"
    )
    
    await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    
    return BotState.SKILLS

# ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è manual –∏ eq

# ==================== AI –ê–ù–ê–õ–ò–ó –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø ====================

async def start_ai_analysis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—É—Å–∫ AI –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã"""
    user_id = update.effective_user.id
    profile = chat_memory.user_profiles[user_id]
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    progress_msg = await context.bot.send_message(
        chat_id=profile.chat_id,
        text="üß† *AI –ê–ù–ê–õ–ò–ó: 1/3 - –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å*\n\n"
             "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...\n"
             "‚è±Ô∏è *–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:* 30-45 —Å–µ–∫—É–Ω–¥\n\n"
             "üîç *–ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é:*\n"
             "‚Ä¢ –õ–∏—á–Ω–æ—Å—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏\n"
             "‚Ä¢ –°–∫—Ä—ã—Ç—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª\n"
             "‚Ä¢ –ò–¥–µ–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞",
        parse_mode='Markdown'
    )
    
    try:
        # 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        analysis = await openai_service.generate_psychological_analysis(profile)
        profile.psychological_analysis = analysis
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        await progress_msg.edit_text(
            "üß† *AI –ê–ù–ê–õ–ò–ó: 2/3 - –ü–æ–∏—Å–∫ –±–∏–∑–Ω–µ—Å-–Ω–∏—à*\n\n"
            "–ü–æ–¥–±–∏—Ä–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∏—à–∏...\n"
            "‚è±Ô∏è *–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:* 45-60 —Å–µ–∫—É–Ω–¥\n\n"
            "üéØ *–ß—Ç–æ –∏—â—É:*\n"
            "‚Ä¢ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ø–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏ –∑–∞ 1-2 –º–µ—Å—è—Ü–∞)\n"
            "‚Ä¢ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã\n"
            "‚Ä¢ –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n"
            "‚Ä¢ –†–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–µ –∏ —Å–∫—Ä—ã—Ç—ã–µ –Ω–∏—à–∏",
            parse_mode='Markdown'
        )
        
        # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–Ω–∏—à
        niches = await openai_service.generate_business_niches(profile, analysis)
        profile.generated_niches = niches
        
        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 3 –Ω–∏—à
        await progress_msg.edit_text(
            "üß† *AI –ê–ù–ê–õ–ò–ó: 3/3 - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã*\n\n"
            "–†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–æ—à–∞–≥–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏...\n"
            "‚è±Ô∏è *–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:* 60-90 —Å–µ–∫—É–Ω–¥\n\n"
            "üìã *–ß—Ç–æ —Å–æ–∑–¥–∞—é:*\n"
            "‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É\n"
            "‚Ä¢ 30-–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω –∑–∞–ø—É—Å–∫–∞\n"
            "‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—É—é –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É\n"
            "‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –∏ —Ä–µ—Å—É—Ä—Å—ã",
            parse_mode='Markdown'
        )
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω—ã –¥–ª—è –ø–µ—Ä–≤—ã—Ö 3 –Ω–∏—à
        for i, niche in enumerate(profile.generated_niches[:3]):
            plan = await openai_service.generate_detailed_plan(profile, niche)
            if plan:
                profile.detailed_plans[niche['name']] = plan
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if i < 2:
                await progress_msg.edit_text(
                    f"üß† *AI –ê–ù–ê–õ–ò–ó: 3/3 - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã*\n\n"
                    f"–°–æ–∑–¥–∞—é –ø–ª–∞–Ω {i+1}/3...\n"
                    f"‚è±Ô∏è *–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è:* {(i+1)*30} —Å–µ–∫—É–Ω–¥",
                    parse_mode='Markdown'
                )
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
        await progress_msg.delete()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        memory_status = get_memory_status()
        
        await context.bot.send_message(
            chat_id=profile.chat_id,
            text=f"üéâ *–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù!*\n\n"
                 f"‚úÖ –°–æ–∑–¥–∞–Ω–æ: {len(profile.generated_niches)} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–Ω–∏—à\n"
                 f"üìä –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç: –≥–æ—Ç–æ–≤\n"
                 f"üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã: {len(profile.detailed_plans)} —à—Ç\n\n"
                 f"üîß *–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ AI:*\n"
                 f"‚Ä¢ –¢–æ–∫–µ–Ω—ã: {chat_memory.token_usage.total_tokens:,}\n"
                 f"‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${chat_memory.token_usage.estimated_cost:.4f}\n\n"
                 f"üëá *–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –Ω–∏—à—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è:*"
                 f"{memory_status}",
            parse_mode='Markdown'
        )
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–∏—à—É
        profile.current_niche_index = 0
        return await show_current_niche(update, context)
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {e}")
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        profile.psychological_analysis = openai_service.create_fallback_analysis(profile)
        profile.generated_niches = openai_service.create_fallback_niches(profile)
        
        for niche in profile.generated_niches[:3]:
            plan = openai_service.create_fallback_plan(profile, niche)
            profile.detailed_plans[niche['name']] = plan
        
        await progress_msg.delete()
        
        await context.bot.send_message(
            chat_id=profile.chat_id,
            text="üéâ *–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù (–±–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º)*\n\n"
                 "‚úÖ –°–æ–∑–¥–∞–Ω–æ 5 –±–∏–∑–Ω–µ—Å-–Ω–∏—à –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤\n"
                 "üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã\n\n"
                 "üëá *–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–≤—É—é –Ω–∏—à—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è:*",
            parse_mode='Markdown'
        )
        
        profile.current_niche_index = 0
        return await show_current_niche(update, context)

async def show_current_niche(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –Ω–∏—à—É"""
    user_id = None
    if update.callback_query:
        user_id = update.callback_query.from_user.id
    elif update.message:
        user_id = update.effective_user.id
    
    if user_id not in chat_memory.user_profiles:
        return ConversationHandler.END
    
    profile = chat_memory.user_profiles[user_id]
    
    if not profile.generated_niches:
        await context.bot.send_message(
            chat_id=profile.chat_id,
            text="‚ùå –ù–∏—à–∏ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ /start",
            parse_mode='Markdown'
        )
        return ConversationHandler.END
    
    niche = profile.generated_niches[profile.current_niche_index]
    total_niches = len(profile.generated_niches)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –Ω–∏—à–∏
    text = format_niche_for_display(niche, profile.current_niche_index + 1, total_niches)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞–º—è—Ç–∏
    text += get_memory_status()
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    keyboard = []
    
    # –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    nav_buttons = []
    if profile.current_niche_index > 0:
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∞—è", callback_data='niche_prev'))
    
    nav_buttons.append(InlineKeyboardButton(f"{profile.current_niche_index + 1}/{total_niches}", callback_data='niche_current'))
    
    if profile.current_niche_index < total_niches - 1:
        nav_buttons.append(InlineKeyboardButton("–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂Ô∏è", callback_data='niche_next'))
    
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    niche_id = niche.get('id', profile.current_niche_index)
    keyboard.append([InlineKeyboardButton("üìã –ü–æ–ª–Ω—ã–π –ø–ª–∞–Ω —ç—Ç–æ–π –Ω–∏—à–∏", callback_data=f'niche_plan_{niche_id}')])
    keyboard.append([InlineKeyboardButton("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∏—à–∏", callback_data='save_all_niches')])
    keyboard.append([InlineKeyboardButton("üß† –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑", callback_data='show_analysis')])
    keyboard.append([InlineKeyboardButton("üè† –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data='start_over')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        await context.bot.send_message(
            chat_id=profile.chat_id,
            text=text,
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    
    return BotState.NICHE_SELECTION

async def handle_niche_navigation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–∏—à–∞–º"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    profile = chat_memory.user_profiles[user_id]
    
    if query.data == 'niche_prev' and profile.current_niche_index > 0:
        profile.current_niche_index -= 1
    elif query.data == 'niche_next' and profile.current_niche_index < len(profile.generated_niches) - 1:
        profile.current_niche_index += 1
    
    elif query.data.startswith('niche_plan_'):
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω
        try:
            niche_id = int(query.data.split('_')[2])
            # –ù–∞—Ö–æ–¥–∏–º –Ω–∏—à—É –ø–æ id –∏–ª–∏ –∏–Ω–¥–µ–∫—Å—É
            if niche_id <= len(profile.generated_niches):
                niche = profile.generated_niches[niche_id - 1]
            else:
                niche = profile.generated_niches[0]
            
            if niche['name'] in profile.detailed_plans:
                plan_text = profile.detailed_plans[niche['name']]
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                full_plan = f"# üìã –ü–û–õ–ù–´–ô –ë–ò–ó–ù–ï–°-–ü–õ–ê–ù\n\n*{niche['name']}*\n\n{plan_text}"
                
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                plan_parts = split_text(full_plan)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏
                keyboard = [
                    [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∏—à–∞–º", callback_data='back_to_niches')],
                    [InlineKeyboardButton("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω", callback_data=f'save_plan_{niche_id}')]
                ]
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                await query.edit_message_text(
                    plan_parts[0],
                    reply_markup=reply_markup,
                    parse_mode='Markdown'
                )
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏
                for part in plan_parts[1:]:
                    await context.bot.send_message(
                        chat_id=profile.chat_id,
                        text=part,
                        parse_mode='Markdown'
                    )
                
                return BotState.DETAILED_PLAN
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–ª–∞–Ω–∞: {e}")
            await query.answer("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–Ω–∞", show_alert=True)
    
    elif query.data == 'save_all_niches':
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –Ω–∏—à–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        await query.answer("–í—Å–µ –Ω–∏—à–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞! ‚úÖ", show_alert=True)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∏—à–∏ –ø–æ –æ–¥–Ω–æ–π
        for i, niche in enumerate(profile.generated_niches):
            niche_text = format_niche_for_display(niche, i + 1, len(profile.generated_niches))
            await context.bot.send_message(
                chat_id=profile.chat_id,
                text=niche_text,
                parse_mode='Markdown'
            )
            await asyncio.sleep(0.5)
        
        return await show_current_niche(update, context)
    
    elif query.data == 'show_analysis':
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
        if profile.psychological_analysis:
            analysis_parts = split_text(f"# üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó\n\n{profile.psychological_analysis}")
            
            keyboard = [[InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –Ω–∏—à–∞–º", callback_data='back_to_niches')]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await query.edit_message_text(
                analysis_parts[0],
                reply_markup=reply_markup,
                parse_mode='Markdown'
            )
            
            for part in analysis_parts[1:]:
                await context.bot.send_message(
                    chat_id=profile.chat_id,
                    text=part,
                    parse_mode='Markdown'
                )
            
            return BotState.NICHE_SELECTION
        else:
            await query.answer("‚ùå –ê–Ω–∞–ª–∏–∑ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω", show_alert=True)
    
    elif query.data == 'start_over':
        # –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
        if user_id in chat_memory.user_profiles:
            del chat_memory.user_profiles[user_id]
        
        keyboard = [[InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∞–Ω–∫–µ—Ç—É", callback_data='start_questionnaire')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(
            "üîÑ *–°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞!*\n\n"
            "–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∞–Ω–∫–µ—Ç—É —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞?\n\n"
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
        
        return BotState.DEMOGRAPHY
    
    elif query.data == 'back_to_niches':
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –Ω–∏—à
        return await show_current_niche(update, context)
    
    elif query.data.startswith('save_plan_'):
        await query.answer("–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞! ‚úÖ", show_alert=True)
        return await show_current_niche(update, context)
    
    return await show_current_niche(update, context)

# ==================== HEALTH CHECK ====================
async def health_check(request):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞"""
    status = {
        "status": "OK",
        "version": "6.0",
        "timestamp": datetime.now().isoformat(),
        "openai_available": openai_service.is_available,
        "statistics": {
            "active_users": len(chat_memory.user_profiles),
            "total_messages": chat_memory.total_messages,
            "token_usage": {
                "total": chat_memory.token_usage.total_tokens,
                "prompt": chat_memory.token_usage.prompt_tokens,
                "completion": chat_memory.token_usage.completion_tokens,
                "estimated_cost": chat_memory.token_usage.estimated_cost
            },
            "memory_usage_percent": chat_memory.get_memory_usage_percentage()
        }
    }
    return web.Response(
        text=json.dumps(status, ensure_ascii=False, indent=2),
        content_type='application/json'
    )

async def run_health_server():
    """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è"""
    app = web.Application()
    app.router.add_get('/health', health_check)
    app.router.add_get('/', health_check)
    
    runner = web.AppRunner(app)
    await runner.setup()
    
    port = int(os.getenv("PORT", "10000"))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    logger.info(f"‚úÖ Health check —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    return runner

# ==================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ====================
def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    
    if not token:
        logger.error("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        logger.info("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é: TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω")
        return
    
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ –ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ v6.0")
    logger.info(f"ü§ñ OpenAI —Å—Ç–∞—Ç—É—Å: {'‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' if openai_service.is_available else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}")
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(token).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    application.add_handler(CommandHandler("start", start))
    
    # –°–æ–∑–¥–∞–µ–º ConversationHandler –¥–ª—è –≤—Å–µ–≥–æ –ø–æ—Ç–æ–∫–∞
    conv_handler = ConversationHandler(
        entry_points=[
            CallbackQueryHandler(start_questionnaire, pattern='^start_questionnaire$')
        ],
        states={
            BotState.DEMOGRAPHY: [
                CallbackQueryHandler(handle_age, pattern='^age_'),
                CallbackQueryHandler(handle_education, pattern='^edu_'),
                CallbackQueryHandler(handle_location, pattern='^loc_'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_custom_location)
            ],
            BotState.PERSONALITY: [
                CallbackQueryHandler(handle_motivation, pattern='^mot_'),
                CallbackQueryHandler(handle_decision_style, pattern='^dec_'),
                CallbackQueryHandler(handle_risk_scenario, pattern='^risk_'),
                CallbackQueryHandler(handle_risk_level, pattern='^risk_'),
                CallbackQueryHandler(handle_energy_level, pattern='^energy_'),
                CallbackQueryHandler(handle_peak_selection, pattern='^(select_|peak_|energy_)'),
                CallbackQueryHandler(handle_fears_selection, pattern='^fear_'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_custom_fear)
            ],
            BotState.SKILLS: [
                CallbackQueryHandler(handle_skill_rating, pattern='^skill_analytics_'),
                CallbackQueryHandler(handle_skill_communication, pattern='^skill_comm_'),
                CallbackQueryHandler(handle_skill_design, pattern='^skill_design_'),
                CallbackQueryHandler(handle_skills_organization, pattern='^skill_org_'),
                CallbackQueryHandler(handle_superpower, pattern='^power_'),
                CallbackQueryHandler(handle_work_style, pattern='^work_'),
                CallbackQueryHandler(handle_learning_distribution, pattern='^learning_')
            ],
            BotState.VALUES: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_existential),
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_flow_experience),
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_flow_feeling),
                CallbackQueryHandler(handle_ideal_client_age, pattern='^client_'),
                CallbackQueryHandler(handle_ideal_client_field, pattern='^field_'),
                CallbackQueryHandler(handle_ideal_client_pain, pattern='^pain_'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_ideal_client_details)
            ],
            BotState.LIMITATIONS: [
                CallbackQueryHandler(handle_budget, pattern='^budget_'),
                CallbackQueryHandler(handle_equipment, pattern='^equip_'),
                CallbackQueryHandler(handle_knowledge_assets, pattern='^know_'),
                CallbackQueryHandler(handle_time_budget, pattern='^time_'),
                CallbackQueryHandler(handle_business_scale, pattern='^scale_'),
                CallbackQueryHandler(handle_business_format, pattern='^format_'),
                CallbackQueryHandler(start_ai_analysis, pattern='^analysis_start$')
            ],
            BotState.ANALYZING: [
                # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞
            ],
            BotState.NICHE_SELECTION: [
                CallbackQueryHandler(handle_niche_navigation, pattern='^(niche_|save_|show_|start_|back_)')
            ],
            BotState.DETAILED_PLAN: [
                CallbackQueryHandler(handle_niche_navigation, pattern='^(back_to_niches|save_plan_)')
            ]
        },
        fallbacks=[
            CommandHandler("start", start)
        ],
        per_message=False
    )
    
    application.add_handler(conv_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    async def run_bot():
        await application.initialize()
        await application.start()
        await application.updater.start_polling(drop_pending_updates=True)
        
        logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        
        # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
        while True:
            await asyncio.sleep(3600)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    asyncio.run(run_bot())

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        logger.info("‚èπ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")