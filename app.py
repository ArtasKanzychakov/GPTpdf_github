#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ë–ò–ó–ù–ï–°-–ù–ê–í–ò–ì–ê–¢–û–† v7.0 - –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞
"""

import asyncio
import os
import sys
import signal
import logging
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.insert(0, str(Path(__file__).parent))

# –°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ setup_logging
try:
    from utils.logger import setup_logging
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–∞–∑—É
    setup_logging()
except ImportError as e:
    print(f"‚ùå –ù–µ –º–æ–≥—É –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å setup_logging: {e}")
    print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ utils/logger.py")
    sys.exit(1)

logger = logging.getLogger(__name__)

# –¢–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
try:
    from config.settings import BotConfig
    from core.bot import BusinessNavigatorBot
    from services.health_check import start_health_check_server
    from services.openai_service import OpenAIService
except ImportError as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π: {e}")
    logger.error("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏")
    logger.error("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ:")
    logger.error("  - config/settings.py")
    logger.error("  - core/bot.py")
    logger.error("  - services/health_check.py")
    logger.error("  - services/openai_service.py")
    sys.exit(1)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è graceful shutdown
bot_instance = None

def signal_handler(signum, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown"""
    logger.info(f"üì∂ –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signum}, –Ω–∞—á–∏–Ω–∞—é graceful shutdown...")
    sys.exit(0)

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    global bot_instance
    
    try:
        logger.info("=" * 60)
        logger.info("üöÄ –ó–ê–ü–£–°–ö –ë–ò–ó–ù–ï–°-–ù–ê–í–ò–ì–ê–¢–û–†–ê v7.0")
        logger.info("=" * 60)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Python –≤–µ—Ä—Å–∏–∏
        python_version = sys.version_info
        logger.info(f"üêç Python –≤–µ—Ä—Å–∏—è: {python_version.major}.{python_version.minor}.{python_version.micro}")
        
        if not (python_version.major == 3 and python_version.minor >= 9):
            logger.warning(f"‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è Python 3.9+. –¢–µ–∫—É—â–∞—è: {sys.version}")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        logger.info("‚öôÔ∏è –ó–∞–≥—Ä—É–∂–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...")
        config = BotConfig()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        if not config.telegram_token:
            logger.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            logger.error("–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:")
            logger.error("1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram")
            logger.error("2. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ Render Dashboard:")
            logger.error("   - Name: TELEGRAM_BOT_TOKEN")
            logger.error("   - Value: –≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞")
            logger.error("3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π")
            sys.exit(1)
        
        # –ú–∞—Å–∫–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ª–æ–≥–æ–≤
        masked_token = config.telegram_token
        if len(masked_token) > 8:
            masked_token = masked_token[:4] + "***" + masked_token[-4:]
        
        logger.info(f"‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞: {masked_token}")
        logger.info(f"ü§ñ OpenAI –º–æ–¥–µ–ª—å: {config.openai_model}")
        logger.info(f"üåê –Ø–∑—ã–∫ –±–æ—Ç–∞: {config.bot_language}")
        logger.info(f"üìù –í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(config.questions)}")
        logger.info(f"üè¢ –ù–∏—à –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {len(config.niche_categories)}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ OpenAI (–µ—Å–ª–∏ –∫–ª—é—á –µ—Å—Ç—å)
        if config.openai_api_key:
            logger.info("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OpenAI...")
            try:
                if openai_service.is_initialized:
                    logger.info("‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                else:
                    logger.warning("‚ö†Ô∏è OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                    logger.warning("–ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Ä–µ–∂–∏–º–µ")
                    
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ OpenAI: {e}")
                logger.warning("–ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Ä–µ–∂–∏–º–µ")
        else:
            logger.warning("‚ö†Ô∏è OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º –±–µ–∑ AI.")
            logger.warning("–î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å—Ç–µ OPENAI_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞
        logger.info("ü§ñ –°–æ–∑–¥–∞—é —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞...")
        bot = BusinessNavigatorBot(config)
        bot_instance = bot
        
        # –ó–∞–ø—É—Å–∫ health check —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è Render) –≤ —Ñ–æ–Ω–µ
        port = int(os.getenv('PORT', config.port))
        logger.info(f"üåê –ó–∞–ø—É—Å–∫–∞—é health check —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É {port}...")
        
        health_task = asyncio.create_task(
            start_health_check_server(host=config.host, port=port)
        )
        
        logger.info("‚úÖ Health check —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω")
        logger.info("-" * 40)
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤
        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)
        
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        logger.info("‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ polling...")
        logger.info("‚ÑπÔ∏è –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∏ health —Å–µ—Ä–≤–µ—Ä –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        bot_task = asyncio.create_task(bot.run())
        
        # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ª—é–±–æ–π –∏–∑ –∑–∞–¥–∞—á
        done, pending = await asyncio.wait(
            [bot_task, health_task],
            return_when=asyncio.FIRST_COMPLETED
        )
        
        # –û—Ç–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏
        for task in pending:
            task.cancel()
            try:
                await task
            except asyncio.CancelledError:
                pass
        
        logger.info("‚èπ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
    except KeyboardInterrupt:
        logger.info("‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Ctrl+C)")
    except Exception as e:
        logger.critical(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
        sys.exit(1)
    finally:
        logger.info("=" * 60)
        logger.info("üëã –ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
        logger.info("=" * 60)

def run_bot():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Render)"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ Render (–µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è PORT)
    port = os.getenv('PORT', '10000')
    logger.info(f"üîß –ü–æ—Ä—Ç –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è: {port}")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é PORT –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞
    os.environ['PORT'] = port
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º event loop –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    if sys.platform == 'win32':
        # Windows —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
        asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("üëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    except RuntimeError as e:
        if "Event loop is closed" in str(e):
            logger.info("üîÑ Event loop –∑–∞–∫—Ä—ã—Ç, –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ")
        else:
            logger.error(f"‚ùå RuntimeError: {e}")
    except Exception as e:
        logger.critical(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
        sys.exit(1)

if __name__ == '__main__':
    run_bot()