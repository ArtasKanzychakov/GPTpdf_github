#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –±–æ—Ç–∞ –ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: FastAPI + python-telegram-bot v20+ (—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å uvloop)
"""
import asyncio
import logging
from typing import Optional, Dict, Any
from dataclasses import dataclass
from telegram.ext import (
    Application,
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters,
    ConversationHandler
)
from config.settings import BotConfig
from handlers.commands import (
    start_command,
    help_command,
    restart_command,
    status_command
)
from handlers.questionnaire import (
    start_questionnaire,
    handle_callback_query,
    handle_question_answer,
    cancel_questionnaire
)
from services.data_manager import data_manager

logger = logging.getLogger(__name__)


@dataclass
class BotStatus:
    """–°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
    is_running: bool = False
    started_at: Optional[float] = None
    total_users: int = 0
    active_sessions: int = 0


class BusinessNavigatorBot:
    """–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –±–æ—Ç–∞ –ë–∏–∑–Ω–µ—Å-–ù–∞–≤–∏–≥–∞—Ç–æ—Ä"""
    
    def __init__(self, config: BotConfig):
        self.config = config
        self.application: Optional[Application] = None
        self._status = BotStatus()
        self._polling_task: Optional[asyncio.Task] = None
        self._initialize_application()

    def _initialize_application(self) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Application"""
        try:
            logger.info("ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Application...")
            
            self.application = (
                ApplicationBuilder()
                .token(self.config.telegram_token)
                .post_init(self._post_init)
                .post_shutdown(self._post_shutdown)
                .build()
            )
            
            self._setup_handlers()
            logger.info("‚úÖ Telegram Application –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Application: {e}")
            raise

    def _setup_handlers(self) -> None:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        if not self.application:
            logger.error("‚ùå Application –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
            
        logger.info("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...")
        
        # === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ===
        self.application.add_handler(CommandHandler("start", start_command))
        self.application.add_handler(CommandHandler("help", help_command))
        self.application.add_handler(CommandHandler("restart", restart_command))
        self.application.add_handler(CommandHandler("status", status_command))
        self.application.add_handler(CommandHandler("questionnaire", start_questionnaire))
        self.application.add_handler(CommandHandler("cancel", cancel_questionnaire))
        
        # === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–Ω–æ–ø–∫–∏) ===
        self.application.add_handler(
            CallbackQueryHandler(handle_callback_query)
        )
        
        # === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ===
        self.application.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_question_answer)
        )
        
        # === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ ===
        self.application.add_error_handler(self._error_handler)
        
        logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")

    async def _post_init(self, application: Application) -> None:
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞"""
        logger.info("üîÑ Post-init –≤—ã–ø–æ–ª–Ω–µ–Ω")
        self._status.started_at = asyncio.get_event_loop().time()

    async def _post_shutdown(self, application: Application) -> None:
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        logger.info("üîÑ Post-shutdown –≤—ã–ø–æ–ª–Ω–µ–Ω")
        self._status.is_running = False
        
        try:
            if data_manager:
                await data_manager.cleanup_old_sessions(days=1)
                logger.info("üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–µ—Å—Å–∏–π: {e}")

    async def _error_handler(self, update: object, context) -> None:
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {context.error}")
        
        try:
            if update and hasattr(update, 'effective_chat'):
                await context.bot.send_message(
                    chat_id=update.effective_chat.id,
                    text="‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start"
                )
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {e}")

    async def start(self) -> None:
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (FastAPI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)"""
        if self._status.is_running:
            logger.warning("‚ö†Ô∏è –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            return
            
        try:
            logger.info("‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...")
            
            if not self.application:
                logger.error("‚ùå Application –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                return
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Application
            await self.application.initialize()
            await self.application.start()
            
            # üîÑ –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º start_polling() –≤–º–µ—Å—Ç–æ run_polling() –¥–ª—è FastAPI
            # start_polling() –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
            self.application.updater.start_polling(
                poll_interval=0.5,
                timeout=10,
                drop_pending_updates=True
            )
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            self._polling_task = asyncio.create_task(self._monitor_polling())
            
            self._status.is_running = True
            self._status.total_users = len(data_manager.sessions)
            self._status.active_sessions = sum(
                1 for s in data_manager.sessions.values() if s.is_active
            )
            
            logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (FastAPI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)")
            logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: {self._status.total_users}")
            logger.info(f"üìä –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: {self._status.active_sessions}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
            self._status.is_running = False
            raise

    async def _monitor_polling(self) -> None:
        """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ polling (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç loop)"""
        try:
            logger.info("üì° Polling –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...")
            # –ü—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏–º –∑–∞–¥–∞—á—É –∞–∫—Ç–∏–≤–Ω–æ–π ‚Äî polling —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ updater
            while self._status.is_running:
                await asyncio.sleep(60)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                logger.debug("üîÑ Polling –∞–∫—Ç–∏–≤–µ–Ω...")
        except asyncio.CancelledError:
            logger.info("‚èπÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ polling –æ—Ç–º–µ–Ω–µ–Ω")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ polling: {e}")

    async def stop(self) -> None:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ (FastAPI-—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è)"""
        if not self._status.is_running:
            logger.warning("‚ö†Ô∏è –ë–æ—Ç —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            return
            
        try:
            logger.info("‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
            self._status.is_running = False
            
            # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–¥–∞—á—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            if self._polling_task and not self._polling_task.done():
                self._polling_task.cancel()
                try:
                    await self._polling_task
                except asyncio.CancelledError:
                    pass
            
            # üîÑ –í–ê–ñ–ù–û: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º updater, –∞ –Ω–µ run_polling
            if self.application and self.application.updater:
                await self.application.updater.stop()
                logger.info("‚úÖ Updater –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
            if self.application:
                await self.application.stop()
                await self.application.shutdown()
                logger.info("‚úÖ Application –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–≤–µ—Ä—à—ë–Ω")
            
            logger.info("‚úÖ –ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞: {e}")
            raise

    def get_status(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
        return {
            "is_running": self._status.is_running,
            "started_at": self._status.started_at,
            "total_users": self._status.total_users,
            "active_sessions": self._status.active_sessions,
            "config": {
                "bot_language": self.config.bot_language,
                "questions_loaded": len(self.config.questions)
            }
        }

    @property
    def is_running(self) -> bool:
        """–°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)"""
        return self._status.is_running

    @property
    def polling_task(self):
        """–ó–∞–¥–∞—á–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)"""
        return self._polling_task
